/*!
 * AcFun Html5 Player
 * @version 1.2.2
 * @author koukuko<9@acfun.tv>
 * 
 * @requires
 * 		ABPlayer - CommentCoreLibrary
 * 			(//github.com/jabbany/CommentCoreLibrary) -
 * 			Licensed under the MIT license
 */
var __extends=this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}__.prototype=b.prototype;d.prototype=new __()};var player;(function(player){var controller=(function(){function controller(){this.httpHost='https://ssl.acfun.tv/';this.wsHost='ws://danmaku.acfun.tv:443/';this.hash=until.hashParse(location.hash.substr(1));this.initialize()}controller.prototype.initialize=function(){var self=this;this.getVideo()};controller.prototype.getVideo=function(){var self=this;if(this.hash.hint){}this.notice('正在获取视频信息');var port=new until.xhr(self.httpHost+'/video/getVideo.aspx?id='+self.hash.vid).done(function(e){var video=until.parseJSON(e);if(video&&video.success){self.data=video;self.getComment(video)}else{self.error('获取视频源信息失败','global.player.controller.initialize:getVideo API Error controller.hash.vid='+self.hash.vid+' '+((typeof video=='object'&&video!=null)?video.result:video))}}).fail(function(){self.error('与AcFun握手失败','global.player.controller.initialize:getVideo Network Error controller.hash.vid='+self.hash.vid)}).run()};controller.prototype.getComment=function(video){var self=this;if(!video){self.error('获取视频源信息失败','global.player.controller.initialize:getVideo API Error controller.hash.vid='+self.hash.vid+' '+((typeof video=='object'&&video!=null)?video.result:video))}this.notice('正在装载弹幕');var port=new until.xhr(self.httpHost+'/danmaku/'+self.hash.vid).done(function(e){var body=new until.$('.display');var comment=e;var stage=document.createElement('div');stage.className='danmaku';body.get(0).appendChild(stage);self.comment=new danmaku.manager(stage);self.comment.load(until.formatDanmaku(comment));self.getRealUrl(video)}).fail(function(){self.error('获取弹幕文件失败','global.player.controller.initialize:getVideo Network Error controller.hash.vid='+self.hash.vid)}).run()};controller.prototype.getRealUrl=function(video){var self=this;this.notice('正在解析视频:'+self.hash.vid);var port=new until.xhr(self.httpHost+'/aliyun/index.php?&type=mobileclient&vid='+self.hash.vid).done(function(e){var data=until.parseJSON(e);if(data&&data.success){var results=[];for(var i in data['result']){results.push(data['result'][i])}results=results.reverse();for(var i in results){if(results[i]['files'][0]['type']=='mp4'){var result=results[i]['files'];break}}if(typeof result=="object"){self.standby(result)}else{self.error('global.player.controller.getRealUrl:'+data.message)}}else{self.error('global.player.controller.getRealUrl:'+self.hash.vid)}}).fail(function(){self.error('global.player.controller.getRealUrl:aliyun Network Error controller.hash.vid='+self.hash.vid)}).run()};controller.prototype.standby=function(files){this.video=new player.video(this,files)};controller.prototype.error=function(message,trace){console.error(new Date().getTime(),message);new until.$('.summary').addClass('error');new until.$('.tips').get(0).innerHTML='(つд⊂) 发生错误了：'+message;new until.$('.status').get(0).innerHTML='[<a onclick="location.reload()" href="#">重新加载</a>] [<a href="mailto:9@acfun.tv?body='+trace+'&subject=【BUG反馈】">发送反馈</a>]';new until.$('.trace').get(0).innerText=trace;new until.$('.circle').addClass('animated fadeOut');new until.$('.info').addClass('animated moveTop')};controller.prototype.notice=function(message){new until.$('.status').get(0).innerText=message};return controller})();player.controller=controller;var video=(function(){function video(contorller,files){this.contorller=contorller;this.files=files;this.ui={window:new until.$(window),body:new until.$('body'),container:new until.$('.container'),controller:new until.$('.controller'),display:new until.$('.display'),play:new until.$('.play'),danmaku:new until.$('.danmaku'),video:undefined,time:{now:new until.$('.now'),length:new until.$('.length')},line:{loaded:new until.$('.line-loaded'),played:new until.$('.line-played'),range:new until.$('.line-range'),output:new until.$('.line-output')},btn:{fullscreen:new until.$('.fullscreen'),fullscreenicon:new until.$('.fullscreen i'),danmaku:new until.$('.hidedanmaku'),danmakuicon:new until.$('.hidedanmaku i'),volume:new until.$('.volume'),volumeicon:new until.$('.volume i')}};this.ready=false;this.lock={seek:false,action:false,touch:false};this.initialize()}video.prototype.initialize=function(){var self=this;var url=this.files[0]['url'];this.element=document.createElement('video');this.element.setAttribute('type','video/mp4');this.element.src=url;this.element.className='video';this.element.preload='auto';this.element.controls=false;this.ui.display.get(0).appendChild(this.element);this.bind();if(until.isIOS){self.ready=self.standby()}};video.prototype.bind=function(){var self=this;var element=new until.$(this.element).on('loadedmetadata',function(){self.ui.line.range.attr('max',self.element.duration);self.ui.line.range.get(0).value=0;self.ui.time.length.get(0).innerText=self.ui.line.range.get(0).value=until.formatTimer(self.element.duration)}).on('durationchange',function(){self.ui.line.range.attr('max',self.element.duration);self.ui.line.range.get(0).value=0;self.ui.time.length.get(0).innerText=self.ui.line.range.get(0).value=until.formatTimer(self.element.duration)}).on('canplay',function(){if(!self.ready)self.ready=self.standby()}).on("progress",function(){if(self.element.buffered.length>0){self.ui.line.loaded.get(0).style.width=self.element.buffered.end(self.element.buffered.length-1)/self.element.duration*100+'%'}}).on("play",function(){self.ui.play.removeClass('icon-play').addClass('icon-pause');self.contorller.comment.startTimer()}).on("pause",function(){self.ui.play.removeClass('icon-pause').addClass('icon-play');self.contorller.comment.stopTimer()}).on('timeupdate',function(){if(!self.lock.seek){self.updateTimeline(self.element.currentTime);self.ui.line.range.get(0).value=self.element.currentTime}self.contorller.comment.time(self.element.currentTime*1000)}).on('seeked',function(){self.contorller.comment.clear()});this.ui.play.on('click',function(){self.togglePlay()});this.ui.danmaku.on('dblclick',function(){until.toggleFullScreen(self.ui.body.get(0));self.ui.btn.fullscreenicon.toggleClass('icon-contract')}).on('click',function(){self.hideController()});this.ui.btn.fullscreen.on('click',function(){until.toggleFullScreen(self.ui.body.get(0));self.ui.btn.fullscreenicon.toggleClass('icon-contract')});this.ui.line.range.on('mousedown',function(){self.lock.seek=true}).on('mousemove',function(){if(self.lock.seek){self.showTooltip(until.formatTimer(this.value))}}).on('mouseup',function(){self.element.currentTime=this.value;self.lock.seek=false}).on('touchstart',function(){self.lock.seek=true}).on('touchmove',function(){if(self.lock.seek){self.showTooltip('跳转到：'+until.formatTimer(this.value))}}).on('touchend',function(){self.element.currentTime=this.value;self.lock.seek=false});var firstTouch,lastTouch,typeTouch,valueTouch;this.ui.danmaku.on('touchstart',function(e){firstTouch=e.targetTouches[0];self.lock.touch=true}).on('touchmove',function(e){lastTouch=e.targetTouches[0];if(!typeTouch&&firstTouch&&lastTouch){if(Math.abs(lastTouch.pageX-firstTouch.pageX)>150){typeTouch='seek'}else if(Math.abs(lastTouch.pageY-firstTouch.pageY)>150){typeTouch='vol'}}if(typeTouch){if(!self.ui.line.output.hasClass('fadeIn')){self.ui.line.output.removeClass('fadeOut').addClass('fadeIn')}var text='';if(typeTouch=='seek'){text+='跳转到：';valueTouch=(lastTouch.pageX-firstTouch.pageX)/self.element.offsetWidth;valueTouch=self.element.currentTime+120*valueTouch;if(valueTouch<0){valueTouch=0}else if(valueTouch>self.element.duration){valueTouch=self.element.duration}text+=until.formatTimer(valueTouch)}else if(typeTouch=='vol'){text+='音量：';valueTouch=(firstTouch.pageY-lastTouch.pageY)/self.element.offsetWidth;valueTouch=self.element.volume+valueTouch;if(valueTouch<0){valueTouch=0}else if(valueTouch>1){valueTouch=1}text+=Math.floor(valueTouch*100)+'%'}self.ui.line.output.get(0).innerText=text}self.lock.touch=false}).on('touchend',function(e){if(typeTouch){if(typeTouch=='seek'){self.element.currentTime=valueTouch}else if(typeTouch=='vol'){self.element.volume=valueTouch}self.ui.line.output.removeClass('fadeIn').addClass('fadeOut');typeTouch=undefined;valueTouch=undefined}});this.ui.window.on('resize',function(){self.contorller.comment.setBounds()});this.ui.btn.danmaku.on('click',function(){if(!self.ui.danmaku){self.ui.danmaku=new until.$('.danmaku')}if(self.ui.danmaku.hasClass('hide')){self.ui.danmaku.removeClass('hide');self.ui.btn.danmaku.get(0).innerHTML='<i class="icon-bubble"><span class="text">弹幕开</span></i></div>'}else{self.ui.danmaku.addClass('hide');self.ui.btn.danmaku.get(0).innerHTML='<i class="icon-bubble2"><span class="text">弹幕关</span></i></div>'}});this.ui.btn.volume.on('click',function(){if(self.element.muted){self.element.muted=false;self.ui.btn.volume.get(0).innerHTML='<i class="icon-volume-medium"><span class="text">声音开</span></i></div>'}else{self.element.muted=true;self.ui.btn.volume.get(0).innerHTML='<i class="icon-volume-mute"><span class="text">静音</span></i></div>'}})};video.prototype.standby=function(){var self=this;this.ui.video=new until.$('.video').addClass('animated fadeIn');this.ui.controller.addClass('fadeIn');this.showTooltip('点击屏幕可以隐藏控制栏');return true};video.prototype.hideController=function(){if(this.ui.controller.hasClass('fadeIn')){this.ui.controller.removeClass('fadeIn').addClass('fadeOut')}else{this.ui.controller.removeClass('fadeOut').addClass('fadeIn')}};video.prototype.togglePlay=function(){if(!this.ready){return false}if(this.element.paused){this.element.play()}else{this.element.pause()}};video.prototype.updateTimeline=function(time){this.ui.time.now.get(0).innerText=until.formatTimer(this.element.currentTime);this.ui.line.played.get(0).style.width=this.element.currentTime/this.element.duration*100+'%'};video.prototype.showTooltip=function(msg){var self=this;self.ui.line.output.get(0).innerText=msg;if(!self.ui.line.output.hasClass('fadeIn')){self.ui.line.output.removeClass('fadeOut').addClass('fadeIn');this.hideTimer=window.setTimeout(function(){self.ui.line.output.removeClass('fadeIn').addClass('fadeOut')},2000)}else{window.clearTimeout(this.hideTimer);this.hideTimer=window.setTimeout(function(){self.ui.line.output.removeClass('fadeIn').addClass('fadeOut')},2000)}};video.prototype.switchPart=function(part){};video.prototype.debugInfo=function(){var video=this.element;var contorller=this.contorller;var info={Video:contorller.data,Url:this.files,Resolution:video.offsetWidth+' x '+video.offsetWidth,Dimensions:video.videoWidth+' x '+video.videoHeight,Decode:{ParsedFrames:video.mozParsedFrames,DecodedFrames:video.mozDecodedFrames||video.webkitDecodedFrameCount,PresentedFrames:video.mozPresentedFrames,PaintedFrames:video.mozPaintedFrames,FrameDelay:video.mozFrameDelay,DroppedFrame:video.webkitDroppedFrameCount,VideoDecodedByteCount:video.webkitVideoDecodedByteCount,AudioDecodedByteCount:video.webkitAudioDecodedByteCount}};return info};return video})();player.video=video;var ws=(function(){function ws(url,controller){this.url=url;this.controller=controller;this.input=new until.$('.send-comment');this.lock={ready:false,send:false,disabled:false};var self=this;this.port=new WebSocket(url);this.port.onclose=function(){self.reconnect()};this.port.onerror=function(){self.error()};this.port.onopen=function(){self.initialize()};this.port.onmessage=function(message){self.handle(message)}}ws.prototype.reconnect=function(){};ws.prototype.error=function(){var self=this;window.setTimeout(function(){self.reconnect()},5000)};ws.prototype.initialize=function(){this.auth()};ws.prototype.handle=function(msg){var self=this;var data=until.parseJSON(msg.data);if(!data){console.error('接收到了一个无法处理的请求:',msg);return false}console.debug('res:',data);switch(data.status){case"202":{this.standby(data.msg)}break;case"200":{if(this.lastComment){self.controller.comment.sendComment({color:"#ffffff",date:self.lastComment.time,hash:self.info.client,id:null,mode:1,size:25,stime:self.lastComment.stime,text:self.lastComment.message,type:2},true)}this.input.get(0).value='';this.controller.video.showTooltip('发送成功');setTimeout(function(){self.unlockSendComment()},3000)}break}};ws.prototype.standby=function(info){var self=this;this.lock.ready=true;info=until.parseJSON(info);this.info=info;if(info){this.lock.disabled=(info.disabled=="false")?false:true}if(this.lock.disabled){this.input.attr('placeholder','抱歉，您的账号没有权限发送弹幕。');this.input.get(0).disabled=true}else{this.input.attr('placeholder','按回车发送哦');this.input.get(0).disabled=false;this.input.on('keydown',function(e){if((e.keyCode||e.which)==13){self.sendComment(this.value)}})}};ws.prototype.sendComment=function(comment){if(!this.lock.ready||this.lock.disabled||this.lock.send){return false}this.controller.video.showTooltip('正在发送...');this.lockSendComment();var self=this;this.lastComment={message:comment,user:until.cookies('auth_key')?until.cookies('auth_key'):this.info.client,color:"16777215",mode:"1",time:Math.floor(new Date().getTime()/1000),"size":25,"stime":self.controller.video.element.currentTime,"isLock":"0"};this.send('post',self.lastComment)};ws.prototype.lockSendComment=function(){this.lock.send=true;this.input.get(0).disabled=true};ws.prototype.unlockSendComment=function(){this.lock.send=false;this.input.get(0).disabled=false};ws.prototype.send=function(action,command){var messgae=JSON.stringify({action:action,command:JSON.stringify(command)});console.log('send:',messgae);this.port.send(messgae)};ws.prototype.auth=function(){var self=this;this.send('auth',{unname:until.cookies('ac_username'),vid:self.controller.data.id,time:new Date().getTime(),uid:until.cookies('auth_key'),uid_ck:until.cookies('auth_key_ac_sha1'),vlength:self.controller.data.time})};return ws})();player.ws=ws})(player||(player={}));var danmaku;(function(danmaku){(function(space){var virt=(function(){function virt(w,h){this.dur=10000;this.pools=[[]];this.pool=this.pools[0];this.width=w;this.height=h}virt.prototype.setBounds=function(w,h){this.width=w;this.height=h};virt.prototype.add=function(cmt){if(cmt.height>=this.height){cmt.cindex=this.pools.indexOf(this.pool);cmt.style.top="0px"}else{cmt.cindex=this.pools.indexOf(this.pool);cmt.style.top=this.setY(cmt)+"px"}};virt.prototype.remove=function(cmt){var tpool=this.pools[cmt.cindex];tpool.remove(cmt)};virt.prototype.validateCmt=function(cmt){cmt.bottom=cmt.offsetTop+cmt.offsetHeight;cmt.y=cmt.offsetTop;cmt.x=cmt.offsetLeft;cmt.right=cmt.offsetLeft+cmt.offsetWidth;cmt.height=cmt.offsetHeight;cmt.width=cmt.offsetWidth;cmt.top=cmt.offsetTop;cmt.left=cmt.offsetLeft;return cmt};virt.prototype.setY=function(cmt,index){if(!index)var index=0;cmt=this.validateCmt(cmt);if(this.pools.length<=index){this.pools.push([])}this.pool=this.pools[index];if(this.pool.length==0){this.pool.push(cmt);return 0}else if(this.vCheck(0,cmt)){this.pool.binsert(cmt,function(a,b){if(a.bottom<b.bottom){return-1}else if(a.bottom==b.bottom){return 0}else{return 1}});return cmt.y}var y=0;for(var k=0;k<this.pool.length;k++){y=this.pool[k].bottom+1;if(y+cmt.offsetHeight>this.height){break}if(this.vCheck(y,cmt)){this.pool.binsert(cmt,function(a,b){if(a.bottom<b.bottom){return-1}else if(a.bottom==b.bottom){return 0}else{return 1}});return cmt.y}}this.setY(cmt,index+1)};virt.prototype.vCheck=function(y,cmt){var bottom=y+cmt.height;var right=cmt.x+cmt.width;this.validateCmt(cmt);for(var i=0;i<this.pool.length;i++){this.pool[i]=this.validateCmt(this.pool[i]);if(this.pool[i].y>bottom||this.pool[i].bottom<y)continue;else if(this.pool[i].right<cmt.x||this.pool[i].x>right){if(this.getEnd(this.pool[i])<this.getMiddle(cmt))continue;else return false}else{return false}}cmt.y=y;cmt.bottom=cmt.height+y;return true};virt.prototype.getEnd=function(cmt){return cmt.stime+cmt.ttl};virt.prototype.getMiddle=function(cmt){return cmt.stime+(cmt.ttl/2)};return virt})();space.virt=virt;var top=(function(_super){__extends(top,_super);function top(){_super.apply(this,arguments)}top.prototype.add=function(cmt){this.validateCmt(cmt);cmt.style.left=(this.width-cmt.width)/2+"px";if(cmt.height>=this.height){cmt.cindex=this.pools.indexOf(this.pool);cmt.style.top="0px"}else{cmt.cindex=this.pools.indexOf(this.pool);cmt.style.top=this.setY(cmt)+"px"}};top.prototype.vCheck=function(y,cmt){var bottom=y+cmt.height;for(var i=0;i<this.pool.length;i++){var c=this.validateCmt(this.pool[i]);if(c.y>bottom||c.bottom<y){continue}else{return false}}cmt.y=y;cmt.bottom=cmt.bottom+y;return true};return top})(virt);space.top=top;var bottom=(function(_super){__extends(bottom,_super);function bottom(){_super.apply(this,arguments)}bottom.prototype.add=function(cmt){cmt.style.top="";cmt.style.bottom="0px";this.validateCmt(cmt);cmt.style.left=(this.width-cmt.width)/2+"px";if(cmt.height>=this.height){cmt.cindex=this.pools.indexOf(this.pool);cmt.style.bottom="0px"}else{cmt.cindex=this.pools.indexOf(this.pool);cmt.style.bottom=this.setY(cmt)+"px"}};bottom.prototype.validateCmt=function(cmt){cmt.y=this.height-(cmt.offsetTop+cmt.offsetHeight);cmt.bottom=cmt.y+cmt.offsetHeight;cmt.x=cmt.offsetLeft;cmt.right=cmt.offsetLeft+cmt.offsetWidth;cmt.height=cmt.offsetHeight;cmt.width=cmt.offsetWidth;cmt.top=cmt.y;cmt.left=cmt.offsetLeft;return cmt};bottom.prototype.vCheck=function(y,cmt){var bottom=y+cmt.height;for(var i=0;i<this.pool.length;i++){var c=this.validateCmt(this.pool[i]);if(c.y>bottom||c.bottom<y){continue}else{return false}}cmt.y=y;cmt.bottom=cmt.bottom+y;return true};return bottom})(virt);space.bottom=bottom;var reverse=(function(_super){__extends(reverse,_super);function reverse(){_super.apply(this,arguments)}reverse.prototype.vCheck=function(y,cmt){var bottom=y+cmt.height;var right=cmt.x+cmt.width;this.validateCmt(cmt);for(var i=0;i<this.pool.length;i++){var c=this.validateCmt(this.pool[i]);if(c.y>bottom||c.bottom<y)continue;else if(c.x>right||c.right<cmt.x){if(this.getEnd(c)<this.getMiddle(cmt))continue;else return false}else{return false}}cmt.y=y;cmt.bottom=cmt.height+y;return true};return reverse})(virt);space.reverse=reverse;var bottomscroll=(function(_super){__extends(bottomscroll,_super);function bottomscroll(){_super.apply(this,arguments)}bottomscroll.prototype.validateCmt=function(cmt){cmt.y=this.height-(cmt.offsetTop+cmt.offsetHeight);cmt.bottom=cmt.y+cmt.offsetHeight;cmt.x=cmt.offsetLeft;cmt.right=cmt.offsetLeft+cmt.offsetWidth;cmt.height=cmt.offsetHeight;cmt.width=cmt.offsetWidth;cmt.top=cmt.y;cmt.left=cmt.offsetLeft;return cmt};bottomscroll.prototype.add=function(cmt){cmt.style.top="";cmt.style.bottom="0px";this.validateCmt(cmt);cmt.style.left=this.width+"px";if(cmt.height>=this.height){cmt.cindex=this.pools.indexOf(this.pool);cmt.style.bottom="0px"}else{cmt.cindex=this.pools.indexOf(this.pool);cmt.style.bottom=this.setY(cmt)+"px"}};return bottomscroll})(virt);space.bottomscroll=bottomscroll})(danmaku.space||(danmaku.space={}));var space=danmaku.space;var filter=(function(){function filter(){this.rulebook={"all":[]};this.modifiers=[];this.runtime=null;this.allowTypes={"1":true,"4":true,"5":true,"6":true,"7":true,"8":true,"17":true}}filter.prototype.doModify=function(cmt){for(var k=0;k<this.modifiers.length;k++){cmt=this.modifiers[k](cmt)}return cmt};filter.prototype.isMatchRule=function(cmtData,rule){switch(rule['operator']){case'==':if(cmtData[rule['subject']]==rule['value']){return false}break;case'>':if(cmtData[rule['subject']]>rule['value']){return false}break;case'<':if(cmtData[rule['subject']]<rule['value']){return false}break;case'range':if(cmtData[rule['subject']]>rule.value.min&&cmtData[rule['subject']]<rule.value.max){return false}break;case'!=':if(cmtData[rule['subject']]!=rule.value){return false}break;case'~':if(new RegExp(rule.value).test(cmtData[rule['subject']])){return false}break;case'!~':if(!(new RegExp(rule.value).test(cmtData[rule['subject']]))){return false}break}return true};filter.prototype.beforeSend=function(cmt){var cmtMode=cmt.data.mode;if(this.rulebook[cmtMode]!=null){for(var i=0;i<this.rulebook[cmtMode].length;i++){if(this.rulebook[cmtMode][i].subject=='width'||this.rulebook[cmtMode][i].subject=='height'){if(this.rulebook[cmtMode][i].subject=='width'){switch(this.rulebook[cmtMode][i].operator){case'>':if(this.rulebook[cmtMode][i].value<cmt.offsetWidth)return false;break;case'<':if(this.rulebook[cmtMode][i].value>cmt.offsetWidth)return false;break;case'range':if(this.rulebook[cmtMode][i].value.max>cmt.offsetWidth&&this.rulebook[cmtMode][i].min<cmt.offsetWidth)return false;break;case'==':if(this.rulebook[cmtMode][i].value==cmt.offsetWidth)return false;break;default:break}}else{switch(this.rulebook[cmtMode][i].operator){case'>':if(this.rulebook[cmtMode][i].value<cmt.offsetHeight)return false;break;case'<':if(this.rulebook[cmtMode][i].value>cmt.offsetHeight)return false;break;case'range':if(this.rulebook[cmtMode][i].value.max>cmt.offsetHeight&&this.rulebook[cmtMode][i].min<cmt.offsetHeight)return false;break;case'==':if(this.rulebook[cmtMode][i].value==cmt.offsetHeight)return false;break;default:break}}}}return true}else{return true}};filter.prototype.doValidate=function(cmtData){if(!this.allowTypes[cmtData.mode])return false;var abstCmtData={text:cmtData.text,mode:cmtData.mode,color:cmtData.color,size:cmtData.size,stime:cmtData.stime,hash:cmtData.hash};if(this.rulebook[cmtData.mode]!=null&&this.rulebook[cmtData.mode].length>0){for(var i=0;i<this.rulebook[cmtData.mode];i++){if(!this.isMatchRule(abstCmtData,this.rulebook[cmtData.mode][i]))return false}}for(var i=0;i<this.rulebook[cmtData.mode];i++){if(!this.isMatchRule(abstCmtData,this.rulebook[cmtData.mode][i]))return false}return true};filter.prototype.addRule=function(rule){if(this.rulebook[rule.mode+""]==null)this.rulebook[rule.mode+""]=[];switch(rule.operator){case'eq':case'equals':case'=':rule.operator='==';break;case'ineq':rule.operator='!=';break;case'regex':case'matches':rule.operator='~';break;case'notmatch':case'iregex':rule.operator='!~';break}this.rulebook[rule.mode].push(rule);return(this.rulebook[rule.mode].length-1)};filter.prototype.addModifier=function(f){this.modifiers.push(f)};filter.prototype.runtimeFilter=function(cmt){if(this.runtime==null)return cmt;return this.runtime(cmt)};filter.prototype.setRuntimeFilter=function(f){this.runtime=f};return filter})();danmaku.filter=filter;var manager=(function(){function manager(stageObject){this.__timer=0;this.lastpos=0;this.def={opacity:1,globalScale:1,scrollScale:1};this.lifetime=0;this.timeline=[];this.runline=[];this.position=0;this.limiter=0;this.filter=null;this.csa={scroll:new danmaku.space.virt(0,0),top:new danmaku.space.top(0,0),bottom:new danmaku.space.bottom(0,0),reverse:new danmaku.space.reverse(0,0),scrollbtm:new danmaku.space.bottomscroll(0,0)};this.stage=stageObject;this.stage.width=this.stage.offsetWidth;this.stage.height=this.stage.offsetHeight;this.lifetime=this.stage.width/140*1000;this.init()}manager.prototype.initCmt=function(cmt,data,newd){cmt.className='comment';cmt.stime=data.stime;cmt.mode=data.mode;cmt.data=data;if(cmt.mode===17){}else{cmt.appendChild(document.createTextNode(data.text));cmt.innerText=data.text;cmt.style.fontSize=data.size+"px"}if(data.font!=null&&data.font!='')cmt.style.fontFamily=data.font;if(data.shadow==false&&data.shadow!=null)cmt.className='comment noshadow';if(data.color=="#000000")cmt.className+=' rshadow';if(data.color!=null)cmt.style.color=data.color;if(this.def.opacity!=1&&data.mode==1)cmt.style.opacity=this.def.opacity;if(data.alphaFrom!=null)cmt.style.opacity=data.alphaFrom;if(data.border||newd)cmt.style.border="1px solid #00ffff";cmt.ttl=Math.round(this.lifetime*this.def.globalScale);cmt.dur=cmt.ttl;if(cmt.mode===1||cmt.mode===6||cmt.mode===2){cmt.ttl*=this.def.scrollScale;cmt.dur=cmt.ttl}return cmt};manager.prototype.startTimer=function(){if(this.__timer>0)return;var lastTPos=new Date().getTime();var cmMgr=this;this.__timer=window.setInterval(function(){var elapsed=new Date().getTime()-lastTPos;lastTPos=new Date().getTime();cmMgr.onTimerEvent(elapsed,cmMgr)},10)};manager.prototype.stopTimer=function(){window.clearInterval(this.__timer);this.__timer=0};manager.prototype.seek=function(time){this.position=this.timeline.bsearch(time,function(a,b){if(a<b.stime)return-1;else if(a>b.stime)return 1;else return 0})};manager.prototype.validate=function(cmt){if(cmt==null)return false;return this.filter.doValidate(cmt)};manager.prototype.load=function(a){this.timeline=a;this.timeline.sort(function(a,b){if(a.stime>b.stime)return 2;else if(a.stime<b.stime)return-2;else{if(a.date>b.date)return 1;else if(a.date<b.date)return-1;else if(a.dbid!=null&&b.dbid!=null){if(a.dbid>b.dbid)return 1;else if(a.dbid<b.dbid)return-1;return 0}else return 0}})};manager.prototype.clear=function(){for(var i=0;i<this.runline.length;i++){this.finish(this.runline[i]);this.stage.removeChild(this.runline[i])}this.runline=[]};manager.prototype.setBounds=function(){for(var comAlloc in this.csa){this.csa[comAlloc].setBounds(this.stage.offsetWidth,this.stage.offsetHeight)}this.stage.width=this.stage.offsetWidth;this.stage.height=this.stage.offsetHeight;this.lifetime=this.stage.width/140*1000};manager.prototype.init=function(){this.setBounds();if(this.filter==null)this.filter=new danmaku.filter()};manager.prototype.time=function(time){time=time-1;if(this.position>=this.timeline.length||Math.abs(this.lastPos-time)>=2000){this.seek(time);this.lastPos=time;if(this.timeline.length<=this.position)return}else this.lastPos=time;for(;this.position<this.timeline.length;this.position++){if(this.validate(this.timeline[this.position])&&this.timeline[this.position]['stime']<=time)this.sendComment(this.timeline[this.position]);else break}};manager.prototype.rescale=function(){for(var i=0;i<this.runline.length;i++){this.runline[i].dur=Math.round(this.runline[i].dur*this.def.globalScale);this.runline[i].ttl=Math.round(this.runline[i].ttl*this.def.globalScale)}};manager.prototype.sendComment=function(data,newd){if(typeof newd==="undefined"){newd=false}if(data.mode===8){console.debug(data);return}var cmt=document.createElement('div');if(this.filter!=null){data=this.filter.doModify(data);if(data==null)return}cmt=this.initCmt(cmt,data,newd);this.stage.appendChild(cmt);cmt.style.width=(cmt.offsetWidth+1)+"px";cmt.style.height=(cmt.offsetHeight-3)+"px";cmt.style.left=this.stage.offsetWidth+"px";cmt.w=cmt.offsetWidth;cmt.h=cmt.offsetHeight;if(this.filter!=null&&!this.filter.beforeSend(cmt)){this.stage.removeChild(cmt);cmt=null;return}switch(cmt.mode){default:case 1:{this.csa.scroll.add(cmt)}break;case 2:{this.csa.scrollbtm.add(cmt)}break;case 4:{this.csa.bottom.add(cmt)}break;case 5:{this.csa.top.add(cmt)}break;case 6:{this.csa.reverse.add(cmt)}break;case 17:case 7:{cmt.style.top=data.y+"px";cmt.style.left=data.x+"px";cmt.ttl=Math.round(data.duration*this.def.globalScale);cmt.dur=Math.round(data.duration*this.def.globalScale);if(data.rY!=0||data.rZ!=0){cmt.style.transformOrigin="0% 0%";cmt.style.webkitTransformOrigin="0% 0%";cmt.style.OTransformOrigin="0% 0%";cmt.style.MozTransformOrigin="0% 0%";cmt.style.MSTransformOrigin="0% 0%";cmt.style.transform="rotateY("+(data.rY>180&&data.rY<270?(0-data.rY):data.rY)+"deg) rotateZ("+(data.rZ>180&&data.rZ<270?(0-data.rZ):data.rZ)+"deg)";cmt.style.webkitTransform="rotateY("+(data.rY>180&&data.rY<270?(0-data.rY):data.rY)+"deg) rotateZ("+(data.rZ>180&&data.rZ<270?(0-data.rZ):data.rZ)+"deg)";cmt.style.OTransform="rotateY("+(data.rY>180&&data.rY<270?(0-data.rY):data.rY)+"deg) rotateZ("+(data.rZ>180&&data.rZ<270?(0-data.rZ):data.rZ)+"deg)";cmt.style.MozTransform="rotateY("+(data.rY>180&&data.rY<270?(0-data.rY):data.rY)+"deg) rotateZ("+(data.rZ>180&&data.rZ<270?(0-data.rZ):data.rZ)+"deg)";cmt.style.MSTransform="rotateY("+(data.rY>180&&data.rY<270?(0-data.rY):data.rY)+"deg) rotateZ("+(data.rZ>180&&data.rZ<270?(0-data.rZ):data.rZ)+"deg)"}}break}this.runline.push(cmt)};manager.prototype.finish=function(cmt){switch(cmt.mode){default:case 1:{this.csa.scroll.remove(cmt)}break;case 2:{this.csa.scrollbtm.remove(cmt)}break;case 4:{this.csa.bottom.remove(cmt)}break;case 5:{this.csa.top.remove(cmt)}break;case 6:{this.csa.reverse.remove(cmt)}break;case 7:break}};manager.prototype.onTimerEvent=function(timePassed,cmObj){for(var i=0;i<cmObj.runline.length;i++){var cmt=cmObj.runline[i];cmt.ttl-=timePassed;if(cmt.mode==1||cmt.mode==2)cmt.style.left=(cmt.ttl/cmt.dur)*(cmObj.stage.width+cmt.w)-cmt.w+"px";else if(cmt.mode==6)cmt.style.left=(1-cmt.ttl/cmt.dur)*(cmObj.stage.width+cmt.w)-cmt.w+"px";else if(cmt.mode==4||cmt.mode==5||cmt.mode>=7){if(cmt.dur==null)cmt.dur=4500;if(cmt.data.alphaFrom!=null&&cmt.data.alphaTo!=null){cmt.style.opacity=(cmt.data.alphaFrom-cmt.data.alphaTo)*(cmt.ttl/cmt.dur)+cmt.data.alphaTo}if(cmt.mode==7&&cmt.data.movable){cmt.style.top=((cmt.data.toY-cmt.data.y)*(Math.min(Math.max(cmt.dur-cmt.data.moveDelay-cmt.ttl,0),cmt.data.moveDuration)/cmt.data.moveDuration)+parseInt(cmt.data.y))+"px";cmt.style.left=((cmt.data.toX-cmt.data.x)*(Math.min(Math.max(cmt.dur-cmt.data.moveDelay-cmt.ttl,0),cmt.data.moveDuration)/cmt.data.moveDuration)+parseInt(cmt.data.x))+"px"}}if(cmObj.filter!=null){cmt=cmObj.filter.runtimeFilter(cmt)}if(cmt.ttl<=0){cmObj.stage.removeChild(cmt);cmObj.runline.splice(i,1);cmObj.finish(cmt)}}};return manager})();danmaku.manager=manager})(danmaku||(danmaku={}));var until;(function(until){until.isMac=navigator.platform.toUpperCase().indexOf('MAC')>=0;until.isMacLike=navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)?true:false;until.isIOS=navigator.platform.match(/(iPhone|iPod|iPad)/i)?true:false;until.prefix=(function(){if('webkitTransform'in document.body.style){return'-webkit-'}else if('MozTransform'in document.body.style){return'-moz-'}else if('msTransform'in document.body.style){return'-ms'}else{return''}})();function formatTimer(s){var t='00:00';if(s>-1){var min=Math.floor(s/60);var sec=Math.floor(s%60);if(min<10){t="0"}else{t=""}t+=min+":";if(sec<10){t+="0"}t+=sec}return t}until.formatTimer=formatTimer;function hashParse(str){var result={};var str=str.split(';');for(var i=0;i<str.length;i++){var c=str[i];var d=c.split('=');result[d[0]]=d[1]}return result}until.hashParse=hashParse;function toggleFullScreen(element){var enableFullScreen=document.fullscreenEnabled||document.mozFullscreenElement||document.webkitFullscreenElement;if(enableFullScreen){if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}else{if(element.requestFullscreen){element.requestFullscreen()}else if(element.mozRequestFullScreen){element.mozRequestFullScreen()}else if(element.webkitRequestFullscreen){element.webkitRequestFullscreen()}else if(element.msRequestFullscreen){element.msRequestFullscreen()}}return document.fullscreenEnabled||document.mozFullscreenElement||document.webkitFullscreenElement}until.toggleFullScreen=toggleFullScreen;var xhr=(function(){function xhr(url){this.port=new XMLHttpRequest();this.port.open("get",url,true)}xhr.prototype.done=function(func){var self=this;this.port.onload=function(){func(self.port.responseText)};return this};xhr.prototype.fail=function(func){this.port.onerror=func;return this};xhr.prototype.run=function(){this.port.send()};return xhr})();until.xhr=xhr;var jsonp=(function(){function jsonp(url){this.script=document.createElement('script');this.onload=function(){};this.onerror=function(){};this.script.src=url}jsonp.prototype.done=function(func){this.script.onload=func;return this};jsonp.prototype.fail=function(func){this.script.onerror=func;return this};jsonp.prototype.run=function(){var self=this;document.getElementsByTagName('head')[0].appendChild(this.script)};return jsonp})();until.jsonp=jsonp;function parseJSON(str){try{var result=JSON.parse(str)}catch(e){var result=null}return result}until.parseJSON=parseJSON;var $=(function(){function $(selector){var els;els=(typeof selector=='string')?document.querySelectorAll(selector):els=[selector];this.els=els}$.prototype.get=function(index){return(typeof index=='undefined')?this.els:this.els[index]};$.prototype.count=function(){return this.els.length};$.prototype.each=function(fn){for(var x=0,max=this.els.length;x<max;x++)fn.call(this,this.els[x]);return this};$.prototype.attr=function(name,value,type){this.each(function(el){if(typeof type=='undefined'){el[name]=value}else{el[type][name]=value}});return this};$.prototype.css=function(styles){var that=this;this.each(function(el){for(var name in styles)that.attr(name,styles[name],'style')});return this};$.prototype.addClass=function(className){var self=this;var className=className.split(' ');this.each(function(el){for(var i=0,length=className.length;i<length;i++){el.classList.add(className[i])}});return this};$.prototype.removeClass=function(className){var self=this;var className=className.split(' ');this.each(function(el){for(var i=0,length=className.length;i<length;i++){el.classList.remove(className[i])}});return this};$.prototype.toggleClass=function(className){var self=this;var className=className.split(' ');this.each(function(el){for(var i=0,length=className.length;i<length;i++){el.classList.toggle(className[i])}});return this};$.prototype.hasClass=function(className){var el=this.get(0);return new RegExp(' '+className+' ').test(' '+el.className+' ')};$.prototype.on=function(event,fn){var addEvent=function(el){if(window.addEventListener){el.addEventListener(event,fn,false)}else if(window.attachEvent){el.attachEvent('on'+event,function(){fn.call(el,window.event)})}};this.each(function(el){addEvent(el)});return this};$.prototype.remove=function(){this.each(function(el){el.parentNode.removeChild(el)});return this};return $})();until.$=$;function formatDanmaku(jsond){function fillRGB(string){while(string.length<6){string="0"+string}return string}var list=[];var jsondt=until.parseJSON(jsond);for(var i=0;i<jsondt.length;i++){for(var j=0;j<jsondt[i].length;j++){var data={id:undefined,stime:undefined,color:undefined,mode:undefined,size:undefined,text:undefined,hash:undefined,date:undefined,type:undefined};var xc=jsondt[i][j]['c'].split(',');if(xc.length>0){data.id=jsondt[i][j]['score'];data.stime=parseFloat(xc[0])*1000;data.color='#'+fillRGB(parseInt(xc[1]).toString(16));data.mode=parseInt(xc[2]);data.size=parseInt(xc[3]);if(data.mode!=7){data.text=jsondt[i][j].m.replace(/(\/n|\\n|\n|\r\n|\\r)/g,"\n");data.text=data.text.replace(/\r/g,"\n");data.text=data.text.replace(/\s/g,"\u00a0")}else data.text=jsondt[i][j].m;data.hash=xc[4];data.date=parseInt(xc[5]);data.type=i;if(data.mode==7){continue}list.push(data)}}}return list}until.formatDanmaku=formatDanmaku;function cookies(name,value,expires){if(value){var d=new Date();d.setTime(d.getTime()+(expires*24*60*60*1000));expires="expires="+d.toGMTString();document.cookie=name+"="+value+"; "+expires}name=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i].trim();if(c.indexOf(name)==0)return c.substring(name.length,c.length)}return""}until.cookies=cookies})(until||(until={}));Array.prototype.remove=function(obj){for(var a=0;a<this.length;a++)if(this[a]==obj){this.splice(a,1);break}};Array.prototype.bsearch=function(what,how){if(this.length==0)return 0;if(how(what,this[0])<0)return 0;if(how(what,this[this.length-1])>=0)return this.length;var low=0;var i=0;var count=0;var high=this.length-1;while(low<=high){i=Math.floor((high+low+1)/2);count++;if(how(what,this[i-1])>=0&&how(what,this[i])<0){return i}else if(how(what,this[i-1])<0){high=i-1}else if(how(what,this[i])>=0){low=i}else console.error('Program Error');if(count>1500)console.error('Too many run cycles.')}return-1};Array.prototype.binsert=function(what,how){this.splice(this.bsearch(what,how),0,what)};var h5p=new player.controller();